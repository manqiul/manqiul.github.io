<!DOCTYPE html>
<html lang="en">

  <head>
    
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>

  Manqiu  L.


  | Tree-based Ensemble Methods Intro and Parameter Tuning

</title>
<meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌌</text></svg>">

<link rel="stylesheet" href="/assets/css/main.css">
<link rel="canonical" href="https://manqiul.github.io/blog/2022/ensemble/">


<!-- Dark Mode -->
<script src="/assets/js/theme.js"></script>
<script src="/assets/js/dark_mode.js"></script>


  </head>

  <body class="fixed-top-nav ">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="https://manqiul.github.io/">
       <span class="font-weight-bold">Manqiu</span>   L.
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              About
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item active">
            <a class="nav-link" href="/blog/">
              Blog
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/courses/">
                Courses
                
              </a>
          </li>
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/experiences/">
                Experiences
                
              </a>
          </li>
          
          
          
          
          
          <li class="nav-item dropdown ">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Interests
                
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
              
              
                <a class="dropdown-item" href="/photography/">Photography</a>
              
              
              
                <div class="dropdown-divider"></div>
              
              
              
                <a class="dropdown-item" href="/reading/">Reading</a>
              
              
              </div>
          </li>
          
          
          
          
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                Projects
                
              </a>
          </li>
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
            <div class="toggle-container">
              <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      





<div class="post">

  <header class="post-header">
    <h2 class="post-title">Tree-based Ensemble Methods Intro and Parameter Tuning</h2>
    <p class="post-meta">January 7, 2022</p>
    <p class="post-tags">
      <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>
      
        ·  
        
        <a href="/blog/tag/machinelearning">
          <i class="fas fa-hashtag fa-sm"></i> machinelearning</a>  
          
      

      
        ·  
        
        <a href="/blog/category/notes">
          <i class="fas fa-tag fa-sm"></i> notes</a>  
          
      

    </p>
  </header>

  <article class="post-content">
    <h2 id="intro">Intro</h2>

<p><strong>Why Ensemble method?</strong>: Even if each classifier is a weak learner (meaning it does only slightly better than random guessing), the ensemble can still be a strong learner. Here are three types <a href="https://blog.paperspace.com/adaboost-optimizer/" target="_blank" rel="noopener noreferrer">source</a>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Bagging</code></li>
  <li><code class="language-plaintext highlighter-rouge">Boosting</code></li>
  <li><code class="language-plaintext highlighter-rouge">Stacking</code></li>
</ul>

<p><strong>Where to find a diverse set of classifiers?</strong></p>

<ul>
  <li>Use different training algorithm</li>
  <li>Use the same training algorithm for every predictor, but to train them on different random subsets of the training set.</li>
</ul>

<p><strong>How to aggregate?</strong>: Usually, we use Vote(take the statistical mode).</p>

<h2 id="bagging-and-pasting"><strong>Bagging and Pasting</strong></h2>

<p>The aggregation function of Bagging and Pasting is typically the statistical mode. The difference is:</p>

<ul>
  <li>Bagging: Sample with replacement</li>
  <li>Pasting: Sample without replacement</li>
</ul>

<h3 id="pasting">
<code class="language-plaintext highlighter-rouge">Pasting</code>：</h3>

<p>Similar to split the dataset into several subsets.</p>

<h3 id="bagging-bootstrap-aggregating">
<code class="language-plaintext highlighter-rouge">Bagging</code>: <a href="https://en.wikipedia.org/wiki/Bootstrap_aggregating" target="_blank" rel="noopener noreferrer">Bootstrap aggregating</a>
</h3>

<p>Given a standard training set \(D\) of size \(n\), bagging generates \(m\) new training sets \(D_{i}\), each of size \(n^′\), by sampling from D uniformly and with replacement.</p>

<p>By sampling with replacement, some observations may be repeated in each \(D_{i}\). If \(n^′=n\), then for large \(n\) the set \(D_{i}\) is expected to have the fraction \((1 - 1/e)≈63.2%\) of the unique examples of D, the rest being duplicates.</p>

<ul>
  <li>
<a href="https://stats.stackexchange.com/questions/88980/why-on-average-does-each-bootstrap-sample-contain-roughly-two-thirds-of-observat" target="_blank" rel="noopener noreferrer">Note</a>: Each draw, the probability of not choosing that item is \((1−\frac{1}{n})\), if we draw \(n\) times, the probability of this item not being chosen would be \((1−\frac{1}{n})^n\). When \(n -&gt; +\infty\)</li>
</ul>

\[lim_{n-&gt;\infty}(1−\frac{1}{n})^n = e^{lim_{n-&gt;\infty}nln(1−\frac{1}{n})}\\
=e^{lim_{n-&gt;\infty}\frac{ln(1−\frac{1}{n})}{1/n}}\\
=e^{lim_{n-&gt;\infty}\frac{dln(1−\frac{1}{n})/dn}{d(1/n)/dn}}\\
=e^{-1} \approx 0.368\]

<p>Then, \(m\) models are fitted using the above \(m\) bootstrap samples and combined by averaging the output (for regression) or voting (for classification).</p>

<p>We usually use Bagging, because:</p>

<ol>
  <li>Bagging doesn’t require that big dataset</li>
  <li>Bagging is less affected by the method of randomness (the pasting is similar to divide dataset into several subsets. The way we split the dataset matters.)</li>
</ol>

<p>Note: Bootstrapping introduces a bit more diversity in the subsets that each predictor is trained on, so <strong>bagging ends up with a slightly higher bias than pasting</strong>, but this also means that <strong>predictors end up being less correlated so the ensemble’s variance is reduced</strong>.</p>

<p>The net result is that the ensemble has <strong>a similar bias but a lower variance</strong> than a single predictor trained on the original training set.</p>

<h3 id="bagging---random-forest">Bagging -&gt; Random Forest</h3>

<p>When training <strong>Random Forest</strong>, at each node only <strong>a random subset of the features</strong> is considered for splitting.</p>

<p>There are two parts of parameters need to be tuned. One is about trees characteristics; the other is about bagging process.
<a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html" target="_blank" rel="noopener noreferrer">Documentation</a></p>

<p><strong>Tree-related</strong></p>

<p>Random forest in sklearn is using CART decision tree, that is, for each node, we use Gini Index to split data. <a href="https://medium.com/@abedinia.aydin/survey-of-the-decision-trees-algorithms-cart-c4-5-id3-97df842831cd" target="_blank" rel="noopener noreferrer">source</a></p>

<p>For decision trees, parameters are:</p>

<ul>
  <li>max_depth int, default=None
    <ul>
      <li>The maximum depth of the tree. If None, then nodes are expanded until all leaves are pure or until all leaves contain less than min_samples_split samples. The min_samples_split is by default 2. So <strong>if we don’t set max_depth, the tree would split until there is only one sample data in the leaf.</strong>
</li>
    </ul>
  </li>
  <li>min_samples_split int or float, default=2
    <ul>
      <li>The minimum number of samples required to split an internal node:</li>
    </ul>
  </li>
  <li>min_samples_leaf int or float, default=1
    <ul>
      <li>The minimum number of samples required to be at a leaf node.</li>
    </ul>
  </li>
  <li>max_leaf_nodes int, default=None
    <ul>
      <li>Grow trees with max_leaf_nodes in best-first fashion. Best nodes are defined as relative reduction in impurity. If None then unlimited number of leaf nodes.</li>
    </ul>
  </li>
  <li>min_impurity_decrease float, default=0.0
    <ul>
      <li>A node will be split if this split induces a decrease of the impurity greater than or equal to this value.</li>
    </ul>
  </li>
  <li>max_features{“auto”, “sqrt”, “log2”}, int or float, default=”auto”
    <ul>
      <li>The number of features to consider when looking for the best split. For classification a good default is: <strong>m = sqrt(p)</strong>
</li>
    </ul>
  </li>
</ul>

<p><strong>Bagging-related</strong></p>

<ul>
  <li>n_estimators int, default=100
    <ul>
      <li>The number of trees in the forest.</li>
    </ul>
  </li>
  <li>criterion {“gini”, “entropy”}, default=”gini”</li>
  <li>oob_score bool, default=False
    <ul>
      <li>Whether to use out-of-bag samples to estimate the generalization score. Only available if bootstrap=True.</li>
    </ul>
  </li>
  <li>Bootstrap bool, default=True
    <ul>
      <li>Whether bootstrap samples are used when building trees. If False, the whole dataset is used to build each tree.</li>
    </ul>
  </li>
  <li>max_samples int or float, default=None
    <ul>
      <li>If bootstrap is True, the number of samples to draw from X to train each base estimator</li>
    </ul>
  </li>
</ul>

<h2 id="boosting"><strong>Boosting</strong></h2>

<p>Boosting is different from bagging in that the weak learners (in tree models, it would be CART trees) are <strong>sequentially built and correlated with each other</strong>. For Bagging, weak learners are independently built.</p>

<p><code class="language-plaintext highlighter-rouge">Adaboost</code></p>

<p>Adaboost was the first boosting algorithm, with a basic idea of sequentially building weak learners based on the former learner, assigning weights to those misclassified sample.</p>

<p>Once all predictors are trained, all predictors have different weights depending on their overall accuracy on the weighted training set, and we get the weighted sum of all predictors.</p>

<figure>

  <picture>
    
      <source media="(max-width: 480px)" srcset="/assets/img/ensemble1-480.webp"></source>
    
      <source media="(max-width: 800px)" srcset="/assets/img/ensemble1-800.webp"></source>
    
      <source media="(max-width: 1400px)" srcset="/assets/img/ensemble1-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/ensemble1.png">

  </picture>

  

</figure>

<p>The weak learners in AdaBoost are decision trees with a single split, called decision stumps for their shortness.</p>

<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        

<figure>

  <picture>
    
      <source media="(max-width: 480px)" srcset="/assets/img/ensemble6-480.webp"></source>
    
      <source media="(max-width: 800px)" srcset="/assets/img/ensemble6-800.webp"></source>
    
      <source media="(max-width: 1400px)" srcset="/assets/img/ensemble6-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/ensemble6.png">

  </picture>

  

</figure>

    </div>
</div>

<p><code class="language-plaintext highlighter-rouge">Gradient Boosting</code></p>

<p>GB was brought up as a generalized version of Adaboost. It is to <strong>minimize the loss of the model by adding weak learners using a gradient descent like procedure</strong>.</p>

<p>Process:</p>

<ul>
  <li>The GB is to fit the new predictor to the residual errors made by the previous predictor</li>
  <li>After all the predictors were built, simply add up the predictions of all the trees.</li>
</ul>

<p>Gradient boosting involves three elements:</p>

<ol>
  <li>A loss function to be optimized.</li>
  <li>A weak learner to make predictions.</li>
  <li>An additive model to add weak learners to minimize the loss function.</li>
</ol>

<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        

<figure>

  <picture>
    
      <source media="(max-width: 480px)" srcset="/assets/img/ensemble5-480.webp"></source>
    
      <source media="(max-width: 800px)" srcset="/assets/img/ensemble5-800.webp"></source>
    
      <source media="(max-width: 1400px)" srcset="/assets/img/ensemble5-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/ensemble5.png">

  </picture>

  

</figure>

    </div>
</div>

<figure>

  <picture>
    
      <source media="(max-width: 480px)" srcset="/assets/img/ensemble7-480.webp"></source>
    
      <source media="(max-width: 800px)" srcset="/assets/img/ensemble7-800.webp"></source>
    
      <source media="(max-width: 1400px)" srcset="/assets/img/ensemble7-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/ensemble7.png">

  </picture>

  

</figure>

<p><code class="language-plaintext highlighter-rouge">XGBoost</code><a href="https://www.kdnuggets.com/2018/08/unveiling-mathematics-behind-xgboost.html" target="_blank" rel="noopener noreferrer">math</a>, <a href="https://arxiv.org/pdf/1603.02754.pdf" target="_blank" rel="noopener noreferrer">original paper</a></p>

<p>Important Advantages<a href="https://www.analyticsvidhya.com/blog/2016/03/complete-guide-parameter-tuning-xgboost-with-codes-python/" target="_blank" rel="noopener noreferrer">source</a>:</p>

<ul>
  <li>Regularization:
    <ul>
      <li>Standard GBM implementation has no regularization like XGBoost, therefore it also helps to reduce overfitting.</li>
      <li>Penalizes building complex tree with several leaf nodes</li>
    </ul>
  </li>
  <li>Parallel Processing:
    <ul>
      <li><a href="http://zhanpengfang.github.io/418home.html" target="_blank" rel="noopener noreferrer">know more here</a></li>
    </ul>
  </li>
  <li>Second derivative:
    <ul>
      <li>Gradient Boosting follows negative gradients to optimize the loss function, XGBoost uses Taylor expansion to calculate the value of the loss function for different base learners.</li>
    </ul>
  </li>
</ul>

<p><code class="language-plaintext highlighter-rouge">LightGBM</code> <a href="https://medium.com/riskified-technology/xgboost-lightgbm-or-catboost-which-boosting-algorithm-should-i-use-e7fda7bb36bc" target="_blank" rel="noopener noreferrer">source</a></p>

<p>Advanced version of XGBoost, has advantage in memory saving.</p>

<p>LightGBM uses <strong>leaf-wise (best-first) tree growth</strong>. It chooses to grow the leaf that minimizes the loss, allowing a growth of an imbalanced tree. Because it doesn’t grow level-wise, but leaf-wise, <strong>overfitting can happen when data is small</strong>. In these cases, it is important to control the tree depth.</p>

<p>XGboost splits up to the specified max_depth hyperparameter and then starts <strong>pruning the tree backwards and removes splits beyond which there is no positive gain</strong>. It uses this approach since sometimes a split of no loss reduction may be followed by a split with loss reduction. XGBoost can also perform leaf-wise tree growth (as LightGBM).</p>

<figure>

  <picture>
    
      <source media="(max-width: 480px)" srcset="/assets/img/ensemble2-480.webp"></source>
    
      <source media="(max-width: 800px)" srcset="/assets/img/ensemble2-800.webp"></source>
    
      <source media="(max-width: 1400px)" srcset="/assets/img/ensemble2-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img class="img-fluid rounded z-depth-1" src="/assets/img/ensemble2.png">

  </picture>

  

</figure>

<h2 id="stacking">Stacking</h2>

<p>Instead of using trivial functions (such as hard voting) to aggregate the predictions of all predictors in an ensemble, Stacking trains a model to perform this aggregation. The final predictor is called blender.</p>

<p>Step 1: the training set is split in two subsets. The first subset is used to train the predictors in the first layer</p>

<p>Step 2: the first layer predictors are used to make predictions on the second (held-out) set. We can create a new training set using these predicted values as input features, and keeping the target values.</p>

<p>Step 3: The blender is trained on this new training set, so it learns to predict the target value given the first layer’s predictions.</p>

<h2 id="feature-importance">Feature Importance</h2>

<p>Scikit-Learn measures a feature’s importance by looking at how much the tree nodes that use that feature reduce impurity on average (across all trees in the forest).</p>

<p><code class="language-plaintext highlighter-rouge">Impurity-based</code>:</p>

<ul>
  <li>
    <p>impurity-based importances are biased towards high cardinality features;</p>
  </li>
  <li>
    <p>impurity-based importances are computed on training set statistics and therefore do not reflect the ability of feature to be useful to make predictions that generalize to the test set (when the model has enough capacity).</p>
  </li>
</ul>

<p><code class="language-plaintext highlighter-rouge">Permutation-based</code>:</p>

<ul>
  <li>
    <p>overcomes limitations of the impurity-based feature importance: they do not have a bias toward high-cardinality features and can be computed on a left-out test set.</p>
  </li>
  <li>
    <p>The computation for full permutation importance is more costly.</p>
  </li>
</ul>


  </article>

  

</div>

    </div>

    <!-- Footer -->

    
<footer class="fixed-bottom">
  <div class="container mt-0">
    © Copyright 2022 Manqiu  L..
    Powered by <a href="http://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a>.

    
    
  </div>
</footer>



  </body>

  <!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Medium Zoom JS -->
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
<script src="/assets/js/zoom.js"></script>


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>

  
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  





</html>
